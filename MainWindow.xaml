<Window x:Class="WpfIndexer.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:helpers="clr-namespace:WpfIndexer.Helpers"
    xmlns:viewModels="clr-namespace:WpfIndexer.ViewModels"
    xmlns:wv2="clr-namespace:Microsoft.Web.WebView2.Wpf;assembly=Microsoft.Web.WebView2.Wpf"
    mc:Ignorable="d"
    Title="WPF Indexer" 
    Height="900" Width="1400"
    MinHeight="600" MinWidth="900"
    Background="{DynamicResource WindowBackgroundColor}"
    Foreground="{DynamicResource TextColor}"
    Icon="icons/logo.png">

    <Window.Resources>
        <helpers:TextToFlowDocumentHighlightConverter x:Key="HighlightConverter" />
        <helpers:FileSizeConverter x:Key="FileSizeConverter" />
        <helpers:ColorConverter x:Key="ColorConverter" />

    </Window.Resources>


    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 1. MENÜ ÇUBUĞU -->
        <Menu Grid.Row="0" Background="{DynamicResource MenuBackgroundColor}" Foreground="{DynamicResource TextColor}" BorderBrush="{DynamicResource BorderColor}" BorderThickness="0">
            <!-- DÜZELTME: "_" karakterleri kaldırıldı -->
            <MenuItem Header="Dosya">
                <MenuItem Header="Sistem Loglarını Aç" Command="{Binding OpenSystemLogCommand}"/>
                <MenuItem Header="Arama Loglarını Aç" Command="{Binding OpenSearchLogCommand}"/>
                <MenuItem Header="Arama Sonuçlarını Dışa Aktar..." Command="{Binding ExportResultsCommand}"/>
                <MenuItem Header="Çıkış" Command="{Binding ExitApplicationCommand}"/>
            </MenuItem>
            <MenuItem Header="İndeks">
                <MenuItem Header="İndeks Yönetimi..." Command="{Binding OpenIndexManagementCommand}"/>
            </MenuItem>
            <MenuItem Header="Ayarlar">
                <MenuItem Header="Uygulama Ayarları..." Command="{Binding OpenSettingsCommand}"/>
            </MenuItem>
            <MenuItem Header="Yardım">
                <MenuItem Header="Arama İpuçları ve Yardım" Command="{Binding OpenHelpCommand}"/>
                <MenuItem Header="Hakkında" Command="{Binding OpenAboutCommand}"/>
            </MenuItem>
        </Menu>

        <Border Grid.Row="1" Background="{DynamicResource WindowBackgroundColor}" Padding="10" 
                BorderBrush="{DynamicResource BorderColor}" BorderThickness="0">
            <StackPanel Orientation="Vertical" HorizontalAlignment="Center">

                <Image Source="icons/logo.png" Height="150" Margin="0,10,0,10" HorizontalAlignment="Center" />

                <Grid Width="500" Height="40">

                    <Border CornerRadius="20" Background="{DynamicResource TextBoxBackgroundColor}" 
                            BorderBrush="{DynamicResource ControlBorderColor}" BorderThickness="1" 
                            VerticalAlignment="Top">

                        <Grid Height="40" Margin="-1,0,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="19*"/>
                                <RowDefinition Height="17*"/>
                                <RowDefinition Height="4*"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />

                            </Grid.ColumnDefinitions>

                            <TextBox x:Name="SearchTextBox" Grid.Column="0" 
                                     Text="{Binding Query, UpdateSourceTrigger=PropertyChanged}" 
     
                                     BorderThickness="0" Background="Transparent" 
                                     VerticalAlignment="Center" Margin="21,0,0,0" FontSize="16"
                           
                                     Foreground="{DynamicResource TextColor}" 
                                     CaretBrush="{DynamicResource TextColor}" Height="24" Grid.RowSpan="2" RenderTransformOrigin="0.5,0.487">
                                <TextBox.InputBindings>

                                    <KeyBinding Key="Enter" Command="{Binding SearchCommand}" />
                                    <KeyBinding Key="Down" Command="ApplicationCommands.NotACommand" />
                                </TextBox.InputBindings>

                            </TextBox>

                            <Button Grid.Column="1" Content="&#xE721;"
                                    FontFamily="Segoe MDL2 Assets" 
                                    Style="{StaticResource SearchButton}" 
                                    Command="{Binding SearchCommand}" Margin="0,0,10,0" Grid.RowSpan="3" />

                        </Grid>
                    </Border>

                    <Popup x:Name="SuggestionPopup"
                           IsOpen="{Binding IsSuggestionsOpen, Mode=OneWay}"
                          
                           PlacementTarget="{Binding ElementName=SearchTextBox}"
                           Placement="Bottom"
                           StaysOpen="False"
                           AllowsTransparency="True"
                 
                           Width="{Binding ElementName=SearchTextBox, Path=ActualWidth}">
                        <Border Background="{DynamicResource PreviewBackgroundColor}" 
                                BorderBrush="{DynamicResource ControlBorderColor}" 
                           
                                BorderThickness="1" CornerRadius="5" Margin="0,2,0,0" MaxHeight="200">
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ListBox ItemsSource="{Binding Suggestions}"
                             
                                         SelectionMode="Single"
                                         Background="Transparent"
                                         Foreground="{DynamicResource TextColor}">

                                    <ListBox.ItemContainerStyle>
                                        <Style TargetType="ListBoxItem">

                                            <Setter Property="Padding" Value="10,5"/>
                                            <Setter Property="Cursor" Value="Hand"/>

                                            <EventSetter Event="PreviewMouseLeftButtonDown" Handler="Suggestion_PreviewMouseLeftButtonDown"/>
                                            <EventSetter Event="KeyDown" Handler="Suggestion_KeyDown"/>

                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">

                                                    <Setter Property="Background" Value="{DynamicResource MenuItemHoverBackgroundColor}"/>
                                                    <Setter Property="Foreground" Value="{DynamicResource MenuItemHoverTextColor}"/>

                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>

                                    </ListBox.ItemContainerStyle>
                                </ListBox>
                            </ScrollViewer>

                        </Border>
                    </Popup>
                </Grid>

                <Expander Header="Arama İpuçları (Kısa)" Margin="0,8,0,0" FontSize="11" 
                          Foreground="{DynamicResource GrayTextColor}" HorizontalAlignment="Center" Width="500">

                    <Border Background="{DynamicResource ControlBackgroundColor}" CornerRadius="3" Padding="8" 
                            BorderBrush="{DynamicResource BorderColor}" BorderThickness="1">
                        <TextBlock FontFamily="Consolas" LineHeight="18" TextWrapping="Wrap"
                   
                                   Foreground="{DynamicResource TextColor}">
                            <Run Text="🔹" FontWeight="Bold" /> <Run Text="ara*" FontStyle="Italic" /> (ile başlayan)
                            <Run Text=" 🔹" FontWeight="Bold" /> <Run Text="ara AND bilgi" FontStyle="Italic" /> (ikisi de)
      
                            <Run Text=" 🔹" FontWeight="Bold" /> <Run Text="&quot;tam metin&quot;" FontStyle="Italic" /> (grup arama)
                            <LineBreak />
                            <Run Text="Daha fazlası için 'Yardım' menüsüne bakın."/>
                        </TextBlock>

                    </Border>
                </Expander>
            </StackPanel>
        </Border>

        <Grid Grid.Row="2" Margin="8">
            <Grid.RowDefinitions>
                <RowDefinition Height="*" MinHeight="100" />

                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" MinHeight="100" />
            </Grid.RowDefinitions>

            <Grid Grid.Row="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />

                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="Arama Sonuçları" FontWeight="Bold" 
                           Foreground="{DynamicResource TextColor}"/>

                <ListView Grid.Row="1"
         
                           ItemsSource="{Binding SearchResults}" 
                          SelectedItem="{Binding SelectedSearchResult}" 
                          Margin="0,4,0,0"
                          MouseDoubleClick="SearchResultsListView_MouseDoubleClick"
 
                           Background="{DynamicResource WindowBackgroundColor}"
                          BorderBrush="{DynamicResource BorderColor}"
                          Foreground="{DynamicResource TextColor}">


                    <ListView.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Dosya Konumunu Aç" Command="{Binding OpenFileLocationCommand}"/>
                        </ContextMenu>

                    </ListView.ContextMenu>
                    <ListView.View>
                        <GridView>
                            <GridViewColumn Header="Dosya Adı" DisplayMemberBinding="{Binding FileName}" Width="250"/>

                            <GridViewColumn Header="Tür" DisplayMemberBinding="{Binding Extension}" Width="60"/>
                            <GridViewColumn Header="Boyut" DisplayMemberBinding="{Binding Size, Converter={StaticResource FileSizeConverter}}" Width="80"/>
                            <GridViewColumn Header="İndeks Adı" DisplayMemberBinding="{Binding IndexName}" Width="150"/>

                            <GridViewColumn Header="Yol" DisplayMemberBinding="{Binding Path}" Width="700"/>
                        </GridView>
                    </ListView.View>
                </ListView>
            </Grid>

            <GridSplitter Grid.Row="1" Height="5" 
    
                           HorizontalAlignment="Stretch" VerticalAlignment="Center" 
                          Background="{DynamicResource BorderColor}" Margin="0,4" />

            <Grid Grid.Row="2">
                <Grid.RowDefinitions>

                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>
                <TextBlock Grid.Row="0" Text="Önizleme" FontWeight="Bold" Margin="0,8,0,4" 
                           Foreground="{DynamicResource TextColor}"/>


                <Border Grid.Row="1" Background="{DynamicResource PreviewBackgroundColor}" 
                        BorderBrush="{DynamicResource BorderColor}" BorderThickness="1">
                    <Grid>
                        <wv2:WebView2 x:Name="WebViewer"
                                      Visibility="{Binding WebViewPreviewVisibility}"
                                      Source="{Binding SelectedPreviewWebViewUri, Mode=OneWay}"
                                      DefaultBackgroundColor="Transparent" />
                        <RichTextBox x:Name="PreviewRichTextBox"
                  
                                     IsReadOnly="True"
                                     VerticalScrollBarVisibility="Auto"
                                     Visibility="{Binding TextPreviewVisibility}"
      
                                     Background="{DynamicResource PreviewBackgroundColor}"
                                     Foreground="{DynamicResource TextColor}"
                              
                                     BorderThickness="0">

                            <helpers:RichTextBoxHelper.BoundDocument>
                                <Binding Path="HighlightedPreviewContent" Converter="{StaticResource HighlightConverter}" />
                            </helpers:RichTextBoxHelper.BoundDocument>
                        </RichTextBox>

                        <Image Source="{Binding SelectedPreviewImagePath, TargetNullValue={x:Null}}" 
                               Stretch="Uniform" 
           
                               Visibility="{Binding ImagePreviewVisibility}" />

                        <MediaElement Source="{Binding SelectedPreviewVideoPath, TargetNullValue={x:Null}}" 
                                      LoadedBehavior="Manual" 
           
                                      UnloadedBehavior="Stop"
                                      Stretch="Uniform"
                                   
                                      Visibility="{Binding VideoPreviewVisibility}" />

                        <TextBlock Text="{Binding UnsupportedMessage}" 
                                   Visibility="{Binding UnsupportedPreviewVisibility}"
                                
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"
                                   TextWrapping="Wrap"
                          
                                   TextAlignment="Center"
                                   FontSize="14"
                                   Foreground="{DynamicResource GrayTextColor}" />

                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <Border Grid.Row="3" 
                Background="{DynamicResource WindowBackgroundColor}" 
                BorderBrush="{DynamicResource BorderColor}" 
                BorderThickness="0,1,0,0" 

                Padding="8" 
                MinHeight="26">

            <TextBlock Text="{Binding StatusMessage}" 
                       VerticalAlignment="Center" 
                       Margin="4,0,0,0" 
    
                       TextTrimming="CharacterEllipsis"
                       Foreground="{DynamicResource TextColor}"/>
        </Border>
    </Grid>
</Window>